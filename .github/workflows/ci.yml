name: CI

on:
    push:
      branches:
        - dev
        - main
    pull_request:
      branches:
        - dev
        - main
    workflow_dispatch:

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
            # this action is used in multiple places
        with:
          toolchain: stable

      ####### Ensure all tools are loaded before rust-cache, or they will be cached themselves ######
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
            # this action is used in multiple places
        with:
          cache-on-failure: true
          cache-all-crates: true

      # Within this workflow we will continue on error, to give
      # maximum information to the developer.
      - run: cargo fmt --all --check
        name: Code style
        if: ${{ !cancelled() }}
      - run: cargo build --locked
        name: Build
        if: ${{ !cancelled() }}
      - run: cargo clippy --locked
        name: Lint
        if: ${{ !cancelled() }}
      - run: cargo doc --no-deps --locked
        name: Documentation
        if: ${{ !cancelled() }}

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
            # this action is used in multiple places
        with:
          toolchain: nightly
          components: llvm-tools-preview
      - uses: taiki-e/install-action@510b3ecd7915856b6909305605afa7a8a57c1b04 # v2.48.1
            # this action is used in multiple places
        with:
          tool: cargo-llvm-cov
          checksum: true
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
            # this action is used in multiple places
        with:
          cache-on-failure: true
          cache-all-crates: true
      - name: Run coverage tests
        run: cargo llvm-cov --all-features --workspace --exclude xtask@0.0.0 --lcov --output-path lcov.info --locked
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: lcov.info
          path: lcov.info
      - name: Send result to coveralls
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
        continue-on-error: true

  build:
    uses: ./.github/workflows/package.yml
    with:
      release: false
