#!/bin/sh -e
# Autogenerates man pages and other CLI documentation.
# Prerequisite installations:
# - `apt install markdown`
# - `cargo install --locked dprint`


# this used to be an xtask
# but
# doing so currently forces ring to recompile spuriously each time (https://github.com/rust-lang/cargo/issues/16134)

T=$(dirname "$0")/..
TOPDIR=$(realpath "$T")

export QCP_MANPAGE_OUT_DIR=$TOPDIR/qcp/misc/generated
cargo test -p qcp -- cli::manpage::test::manpages cli::manpage::test::markdown
echo "Man pages written to ${QCP_MANPAGE_OUT_DIR}"
echo "Markdown written to ${QCP_MANPAGE_OUT_DIR}/qcp.md"

HTML="${QCP_MANPAGE_OUT_DIR}/qcp.html"
echo "<!-- CAUTION: This file is autogenerated: Do not edit -->" > "${HTML}"
echo >> "${HTML}"
markdown "${QCP_MANPAGE_OUT_DIR}/qcp.md" >> "${HTML}"
echo "HTML written to ${HTML}"
dprint fmt "${HTML}"
